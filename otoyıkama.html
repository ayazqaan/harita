<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Viteska – Oto Yıkama Haritası</title>
<style>
  *{
    -webkit-tap-highlight-color:transparent!important;
    outline:none!important;
    box-shadow:none!important;
    box-sizing:border-box;
  }
  :root{
    --accent:#3483fa; /* OTO YIKAMA – MAVİ TEMA */
    --font:'Segoe UI',sans-serif;
    --radius:14px;
  }
  html,body{
    margin:0;padding:0;
    font-family:var(--font);
    width:100vw;height:100vh;
    background:#fff;
    overflow:hidden;
  }

  /* Üst bar */
  .topbar{
    display:flex;
    justify-content:center;
    align-items:center;
    height:52px;
    background:#fff;
    border-bottom:2px solid #ececec;
    padding:0 10px;
  }

  .top-pill{
    background:var(--accent);
    color:#fff;
    font-weight:800;
    font-size:1.03rem;
    padding:12px 18px;
    border-radius:4px;
  }

  /* Mesafe filtresi */
  .distance-bar{
    width:100%;
    background:#fff;
    display:flex;
    gap:10px;
    padding:8px 10px;
    border-bottom:2px solid #ececec;
  }
  .dist-btn{
    flex:1;
    padding:6px 0;
    background:#fff;
    border:2px solid #bcd6ff;
    border-radius:10px;
    font-weight:700;
    text-align:center;
    font-size:.86rem;
    color:var(--accent);
    cursor:pointer;
    white-space:nowrap;
  }
  .dist-btn.active{
    background:var(--accent);
    color:#fff;
    border-color:var(--accent);
  }

  /* Harita alanı */
  #mapWrap{
    width:100vw;
    height:calc(100vh - 52px - 50px); /* topbar + mesafe filtresi */
    position:relative;
  }
  #map{width:100%;height:100%;}
  #mapLoading{
    position:absolute;
    top:50%;left:50%;
    transform:translate(-50%,-50%);
    background:#eef4ff;
    color:#2458ad;
    font-weight:600;
    font-size:.95rem;
    padding:12px 16px;
    border-radius:12px;
    z-index:20;
    box-shadow:0 3px 12px #b8d1ff80;
  }

  /* Alttaki harita bilgi kutusu */
  .info-box{
    position:fixed;
    left:0;
    bottom:0;
    width:100vw;
    background:#f6f9ff;
    border-top:1px solid #c5d7ff;
    padding:8px 30px 9px 10px; /* sağda X butonu için boşluk */
    font-size:.74rem;
    color:#555;
    line-height:1.3;
    z-index:25;
  }
  .info-title{
    font-weight:800;
    margin-bottom:3px;
    color:var(--accent);      /* tema rengi */
    font-size:.86rem;         /* bir tık büyük */
  }
  .info-text b{color:#000;}

  .info-close{
    position:absolute;
    top:5px;
    right:6px;
    width:24px;
    height:24px;
    border-radius:50%;
    border:none;
    background:#e53935;       /* kırmızı, belirgin X */
    color:#fff;
    font-weight:900;
    font-size:.9rem;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    box-shadow:0 2px 6px rgba(0,0,0,.25);
  }

  /* Rota kutusu – info-box'ın üstünde */
  #routeInfoBox{
    position:fixed;
    left:0;
    bottom:54px;  /* info-box yüksekliği kadar yukarıda */
    width:100vw;
    z-index:30;
    display:none;
    pointer-events:none;
  }
  .route-info-inner{
    width:100vw;
    background:#fff;
    color:#222;
    border-radius:18px 18px 0 0;
    box-shadow:0 -4px 16px #0002;
    padding:16px 14px 12px;
    border-top:4px solid var(--accent);
    pointer-events:auto;
    font-size:.9rem;
  }
  .route-title{
    font-weight:800;
    font-size:1.02rem;
    color:var(--accent);
    margin-bottom:4px;
  }
  .route-line{margin:3px 0;font-weight:600;}
  .route-line span{color:#666;font-weight:500;}

  .route-btn-group{
    display:flex;
    gap:10px;
    margin-top:10px;
  }
  .route-gmaps-btn,.route-cancel-btn{
    flex:1;
    background:var(--accent);
    color:#fff;
    border:none;
    border-radius:10px;
    font-weight:700;
    font-size:.88rem;
    padding:8px;
    cursor:pointer;
  }
  .route-cancel-btn{background:#111;}
</style>
</head>
<body>

<!-- ÜST BAR -->
<div class="topbar">
  <div class="top-pill">Oto Yıkama</div>
</div>

<!-- MESAFE FİLTRESİ -->
<div class="distance-bar">
  <div class="dist-btn active" data-radius="1000">1 KM</div>
  <div class="dist-btn" data-radius="500">500 M</div>
  <div class="dist-btn" data-radius="2000">2 KM</div>
  <div class="dist-btn" data-radius="5000">5 KM</div>
</div>

<!-- HARİTA -->
<div id="mapWrap">
  <div id="map"></div>
  <div id="mapLoading">Harita yükleniyor...</div>
</div>

<!-- ALTTaki HARİTA BİLGİ KUTUSU -->
<div class="info-box" id="infoBox">
  <button class="info-close" onclick="closeInfoBox()">×</button>
  <div class="info-title">Harita Bilgilendirme</div>
  <div class="info-text">
    Bu harita, <b>bulunduğunuz konumu merkez</b> alarak çevrenizdeki oto yıkama ve oto kuaför işletmelerini gösterir.<br>
    Yukarıdaki mesafe çubuğundan <b>yarıçapı değiştirebilir</b>, işaretçilere dokunarak rota oluşturabilirsiniz.<br>
    <b>En uygun ve en güncel oto yıkamaları ön plana çıkarıyoruz</b> — rota süresi ve
    mesafe bilgisi Google Maps verilerine göre canlı hesaplanır.
  </div>
</div>

<!-- ROTA PANEL -->
<div id="routeInfoBox">
  <div class="route-info-inner" id="routeInfoInner"></div>
</div>

<script>
/*** VİTESKA – OTO YIKAMA HARİTASI (Akaryakıt sayfası ile aynı mantık) ***/

let map, userPos=null, userMarker=null;
let placesService, directionsService, directionsRenderer;
let markers = [];
let MAX_RESULTS = 25;
let SEARCH_RADIUS = 1000;      // varsayılan 1 km

/* Markerları sil */
function clearMarkers(){
  markers.forEach(m => m.setMap(null));
  markers = [];
}

/* Yakındaki oto yıkamaları getir */
function loadStations(){
  if(!userPos || !placesService) return;

  clearMarkers();

  const request = {
    location: userPos,
    radius: SEARCH_RADIUS,
    type: "car_wash",   // oto yıkama tipi
    language: "tr"
    // istersen şunu da ekleyebilirsin:
    // keyword: "oto yıkama"
  };

  placesService.nearbySearch(request,(results,status)=>{
    if(status !== google.maps.places.PlacesServiceStatus.OK || !results){
      console.log("Oto yıkama bulunamadı:", status);
      return;
    }

    let count = 0;
    for(const place of results){
      if(count >= MAX_RESULTS) break;
      if(!place.geometry || !place.geometry.location) continue;

      const marker = new google.maps.Marker({
        map,
        position: place.geometry.location,
        title: place.name,
        icon:{
          path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
          scale: 7,
          fillColor: "#3483fa",
          fillOpacity: 1,
          strokeColor: "#ffffff",
          strokeWeight: 1
        }
      });

      marker.addListener("click",()=> createRoute(place));
      markers.push(marker);
      count++;
    }
  });
}

/* Haritayı başlat */
function initMap(){
  const loadingEl = document.getElementById("mapLoading");

  navigator.geolocation.getCurrentPosition(pos=>{
    userPos = {lat:pos.coords.latitude, lng:pos.coords.longitude};

    map = new google.maps.Map(document.getElementById("map"),{
      center:userPos,
      zoom:14,
      streetViewControl:false,
      mapTypeControl:false
    });

    userMarker = new google.maps.Marker({
      map,
      position:userPos,
      title:"Konumunuz",
      icon:{
        path: google.maps.SymbolPath.CIRCLE,
        scale: 8,
        fillColor:"#18b501",
        fillOpacity:1,
        strokeColor:"#ffffff",
        strokeWeight:2
      }
    });

    placesService      = new google.maps.places.PlacesService(map);
    directionsService  = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
      suppressMarkers:true,
      polylineOptions:{ strokeColor:"#3483fa", strokeWeight:4 }
    });
    directionsRenderer.setMap(map);

    loadStations();
    loadingEl.style.display="none";

  },err=>{
    loadingEl.textContent = "Konum alınamadı!";
    console.error("Konum hatası:", err);
  }, {enableHighAccuracy:true, timeout:8000});
}

/* Rota oluştur */
function createRoute(place){
  directionsService.route({
    origin: userPos,
    destination: place.geometry.location,
    travelMode: "DRIVING"
  },(res,status)=>{
    if(status !== google.maps.DirectionsStatus.OK || !res) return;

    directionsRenderer.setDirections(res);
    const leg = res.routes[0].legs[0];

    showRouteInfo({
      title: place.name,
      address: place.vicinity || "",
      distance: leg.distance.text,
      duration: leg.duration.text,
      lat: place.geometry.location.lat(),
      lng: place.geometry.location.lng()
    });
  });
}

/* Alt rota panelini doldur */
function showRouteInfo(data){
  const box   = document.getElementById("routeInfoBox");
  const inner = document.getElementById("routeInfoInner");

  inner.innerHTML = `
    <div class="route-title">${data.title}</div>
    ${data.address ? `<div class="route-line"><b>Adres:</b> <span>${data.address}</span></div>` : ""}
    <div class="route-line"><b>Mesafe:</b> <span>${data.distance}</span></div>
    <div class="route-line"><b>Süre:</b> <span>${data.duration}</span></div>

    <div class="route-btn-group">
      <button class="route-gmaps-btn" onclick="goMaps(${data.lat},${data.lng})">Google Haritalar</button>
      <button class="route-cancel-btn" onclick="closeRoute()">Kapat</button>
    </div>
  `;

  box.style.display = "block";
}

function goMaps(lat,lng){
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`,"_blank");
}

function closeRoute(){
  document.getElementById("routeInfoBox").style.display="none";
  if(directionsRenderer) directionsRenderer.set("directions", null);
}

/* Bilgi kutusunu kapat (X) */
function closeInfoBox(){
  const box = document.getElementById("infoBox");
  if(box) box.style.display = "none";

  const routeBox = document.getElementById("routeInfoBox");
  if(routeBox) routeBox.style.bottom = "0";
}

/* MESAFE FİLTRESİ – tamamen butona göre, popup yok */
document.addEventListener("click", e=>{
  if(e.target.classList.contains("dist-btn")){
    document.querySelectorAll(".dist-btn").forEach(btn=>btn.classList.remove("active"));
    e.target.classList.add("active");

    SEARCH_RADIUS = Number(e.target.dataset.radius); // 500 / 1000 / 2000 / 5000
    loadStations();
  }
});

window.initMap = initMap;
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-MpFcUMdFif1OPAGWcBhmWjWDPaM7Qz0&libraries=places&callback=initMap" async defer></script>
</body>
</html>
