<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Viteska – Oto Yıkama Haritası</title>
<style>
  *{ -webkit-tap-highlight-color:transparent!important; outline:none!important; box-shadow:none!important; }
  :root{
    --accent:#3483fa;         /* OTO YIKAMA rengi (mavi) */
    --color-bg:#fff; 
    --font:'Segoe UI',sans-serif;
  }
  html,body{margin:0;padding:0;font-family:var(--font);background:var(--color-bg);width:100vw;height:100vh;overflow:hidden;}

  /* Üst etiket (yalnızca sayfa adı) */
  .topbar{display:flex;align-items:center;height:52px;background:#fff;border-bottom:2px solid #ececec;padding:0 10px}
  .top-pill{background:var(--accent);color:#fff;font-weight:800;font-size:1.03rem;padding:12px 18px;border-radius:4px}

  /* Harita alanı */
  #mapWrap{width:100vw;height:calc(100vh - 52px);position:relative}
  #map{width:100%;height:100%}
  #mapLoading{
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    background:#eef4ff;color:#2458ad;font-weight:600;font-size:1.05rem;
    padding:18px 22px;border-radius:12px;z-index:222;box-shadow:0 3px 22px #b8d1ff66;
  }

  /* Modal (mekan detayı) */
  .modal-bg{display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;z-index:9999;background:rgba(41,18,0,.23);align-items:center;justify-content:center}
  .modal-bg.active{display:flex}
  .modal-inner{background:#f6f9ff;border-radius:13px;padding:18px 14px 20px;max-width:340px;width:96vw;box-shadow:0 7px 36px #2466c740}
  .place-photo{width:100%;max-height:200px;border-radius:11px;object-fit:cover;margin-bottom:7px}
  .modal-main-title{font-size:1.18em;font-weight:700;color:var(--accent);margin-bottom:6px}
  .modal-detail{color:#395079;font-size:.98em;margin-bottom:5px}
  .modal-city{color:#2466c7;font-size:.98em;margin-bottom:4px}
  .stars{color:#e08e1e;font-size:1.11em;margin-bottom:7px;letter-spacing:.08em}
  .modal-btn-group{display:flex;gap:12px;justify-content:center;margin-top:10px}
  .modal-btn,.modal-close-btn{background:var(--accent);color:#fff;border:none;padding:8px 20px;border-radius:9px;font-weight:600;font-size:1.02rem;cursor:pointer}
  .modal-close-btn{background:#111!important}

  /* Rota bilgi kutusu (altta) */
  #routeInfoBox{position:fixed;left:0;bottom:0;width:100vw;z-index:10001;display:none;pointer-events:none}
  .route-info-inner{width:100vw;background:#fff;color:#222;border-radius:26px 26px 0 0;box-shadow:0 -4px 26px #3483fa40;
                    font-weight:500;font-size:1.05rem;padding:24px 16px 18px;border-top:5px solid var(--accent);pointer-events:auto}
  .route-title{font-weight:800;font-size:1.14rem;margin-bottom:4px;color:var(--accent);display:flex;align-items:center;gap:10px}
  .route-dist,.route-dur{display:flex;align-items:center;gap:6px;font-weight:600;margin-bottom:2px}
  .route-btn-group{display:flex;gap:12px;justify-content:center;margin-top:8px}
  .route-gmaps-btn,.route-cancel-btn{background:var(--accent);color:#fff;border:none;border-radius:12px;font-weight:700;font-size:1rem;padding:10px 18px;cursor:pointer;display:flex;align-items:center;gap:7px}
  .route-cancel-btn{background:#111!important}

  /* Açılış pop-up */
  .popup-info-bg{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(41,18,0,.22);display:flex;align-items:center;justify-content:center;z-index:10010}
  .popup-info{background:#f6f9ff;border-radius:16px;padding:38px 32px 30px;max-width:350px;width:95vw;box-shadow:0 6px 50px #2466c718;text-align:center}
  .popup-count{margin:12px auto 0;color:var(--accent);font-size:1.6em;font-weight:800;letter-spacing:.05em}
</style>
</head>
<body>

  <!-- Üstte tek etiket -->
  <div class="topbar">
    <div class="top-pill">Oto Yıkama</div>
  </div>

  <!-- Harita -->
  <div id="mapWrap">
    <div id="map"></div>
    <div id="mapLoading" style="display:none;">Harita yükleniyor...</div>
  </div>

  <!-- Açılış Bilgilendirme -->
  <div class="popup-info-bg" id="infoPopup" style="display:none;">
    <div class="popup-info">
      <b><span id="popupRadius">3 KM</span> Çevrenizdeki Oto Yıkamalar</b>
      <div style="margin-top:10px;font-weight:500;">
        Konumunuza yakın oto yıkamalar gösteriliyor.<br><br>
        <span style="color:var(--accent);font-weight:700;">Harita yükleniyor...</span>
        <div class="popup-count"><span id="popupCountdown">5</span></div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-bg" id="modalBg"></div>

  <!-- Rota kutusu -->
  <div id="routeInfoBox"><div class="route-info-inner" id="routeInfoInner"></div></div>

<script>
/*** Bu sayfa SADECE Oto Yıkama için ***/
const CATEGORY = { keyword: "Oto Yıkama", key: "yikamaci", color: "#3483fa" };

/* Hedef: 5 km içinde en fazla 100 sonuç */
const MAX_RESULTS = 40;
const SEARCH_RADIUS = 3000;  // 5 km sabit

/* Oto yıkama için zengin anahtar kelimeler + type: "car_wash" */
const WASH_KEYWORDS = [
  "Oto Yıkama","Araç Yıkama","Arac Yıkama","Oto Kuaför","Detaylı Temizlik",
  "İç Dış Yıkama","Buharlı Yıkama","Pasta Cila","Detaylı İç Temizlik","Car Wash"
];
const WASH_TYPES = ["car_wash"]; // Google Places resmi tipi

let map, markers = [], userMarker = null, userPos = null;
let directionsService, directionsRenderer, routeInterval = null;
let popupInterval = null;

/* Pop-up: her girişte göster ve sayaçla kapat */
function showPopupAlways(){
  const el = document.getElementById("infoPopup");
  el.style.display = "flex";
  let c = 5;
  document.getElementById("popupCountdown").innerText = c;
  popupInterval = setInterval(()=>{
    c--; document.getElementById("popupCountdown").innerText = c;
    if(c<=0){ clearInterval(popupInterval); el.style.display="none"; }
  },1000);
}

/* Markerları temizle */
function clearMarkers(){ markers.forEach(m=>m.setMap(null)); markers=[]; }

/* Çoklu arama: keyword + type kombinasyonları, 5 km içinde, MAX_RESULTS hedef */
function fetchAllPages(callback){
  const svc = new google.maps.places.PlacesService(map);
  const seen = new Set();     // place_id tekilleştirme
  const merged = [];

  function runOneSearch(job, done){
    function step(pageToken){
      const req = {
        location: userPos,
        radius: SEARCH_RADIUS,
        language: "tr",
        ...(job.keyword ? { keyword: job.keyword } : {}),
        ...(job.type ? { type: job.type } : {}),
        ...(pageToken ? { pageToken } : {})
      };
      svc.nearbySearch(req, (results, status, pagination)=>{
        if(status === google.maps.places.PlacesServiceStatus.OK && results){
          for(const p of results){
            if(!p.place_id) continue;
            if(!seen.has(p.place_id)){
              seen.add(p.place_id);
              merged.push(p);
            }
            if(merged.length >= MAX_RESULTS) break;
          }
          if(merged.length >= MAX_RESULTS){ done(); return; }
          if(pagination && pagination.hasNextPage){
            setTimeout(()=>pagination.nextPage(), 1350);
            return;
          }
        }
        done();
      });
    }
    step();
  }

  // İş listesi: keyword-only, keyword+type, type-only
  const jobs = [];
  for(const kw of WASH_KEYWORDS){
    jobs.push({ keyword: kw, type: null });
    for(const tp of WASH_TYPES){
      jobs.push({ keyword: kw, type: tp });
    }
  }
  for(const tp of WASH_TYPES){ jobs.push({ keyword: null, type: tp }); }

  let i = 0;
  function next(){
    if(i >= jobs.length || merged.length >= MAX_RESULTS){
      callback(merged);
      return;
    }
    runOneSearch(jobs[i++], next);
  }
  next();
}

/* Marker ekle */
function addMarker(place){
  const marker = new google.maps.Marker({
    map, position: place.geometry.location, title: place.name,
    icon:{ path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW, scale:6, fillColor: CATEGORY.color, fillOpacity:1, strokeWeight:1, strokeColor:"#fff" }
  });
  marker.addListener('click', ()=>showPlaceDetail(place.place_id));
  markers.push(marker);
}

/* Listeyi yükle */
function loadPlaces(){
  clearMarkers();
  fetchAllPages(results => {
    // console.log("Toplam oto yıkama (5km):", results.length);
    results.forEach(addMarker);
  });
}

/* Haritayı başlat */
function initMap(){
  document.getElementById('mapLoading').style.display='';
  navigator.geolocation.getCurrentPosition(pos=>{
    userPos = {lat: pos.coords.latitude, lng: pos.coords.longitude};
    map = new google.maps.Map(document.getElementById('map'), {
      center:userPos, zoom:13, mapTypeControl:false, streetViewControl:false, fullscreenControl:false
    });
    userMarker = new google.maps.Marker({
      map, position:userPos,
      icon:{ path:google.maps.SymbolPath.CIRCLE, scale:9, fillColor:"#18b501", fillOpacity:1, strokeColor:"#fff", strokeWeight:2 },
      title:"Konumunuz"
    });
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
      suppressMarkers:true, polylineOptions:{ strokeColor: CATEGORY.color, strokeWeight:5 }, preserveViewport:true
    });
    directionsRenderer.setMap(map);
    loadPlaces();
    document.getElementById('mapLoading').style.display='none';
  }, ()=>{
    alert('Konum alınamadı. Lütfen konum izni verin.');
    document.getElementById('mapLoading').style.display='none';
  });
}

/*** Modal ***/
function showPlaceDetail(placeId){
  const modalBg = document.getElementById('modalBg');
  modalBg.classList.add('active');
  modalBg.innerHTML = `<div class="modal-inner"><div style="padding:29px 0;text-align:center;">Yükleniyor...</div></div>`;
  const svc = new google.maps.places.PlacesService(map);
  svc.getDetails({
    placeId,
    fields:['name','rating','photos','formatted_address','vicinity','formatted_phone_number','website','opening_hours','geometry']
  }, (place, status)=>{
    if(status !== google.maps.places.PlacesServiceStatus.OK) return;
    const photoUrl = place.photos && place.photos[0] ? place.photos[0].getUrl({maxWidth:410,maxHeight:200}) : '';
    const stars = place.rating ? `<div class="stars">★ ${place.rating.toFixed(1)}</div>` : '';
    const addr = place.formatted_address || place.vicinity || '';
    const phoneBtn = place.formatted_phone_number ? `<a href="tel:${place.formatted_phone_number.replace(/\s+/g,'')}" class="modal-btn">Ara</a>` : '';
    const goBtn = `<button class="modal-btn" style="margin-top:9px;" onclick="startRoutePreview('${(place.name||'').replace(/'/g,"\\'")}', ${place.geometry.location.lat()}, ${place.geometry.location.lng()})">Göz At</button>`;
    const closeBtn = `<button class="modal-close-btn" style="margin-top:9px;" onclick="closeModal()">Kapat</button>`;
    modalBg.innerHTML = `
      <div class="modal-inner" onclick="event.stopPropagation()">
        ${photoUrl?`<img src="${photoUrl}" class="place-photo" alt="Görsel">`:""}
        <div class="modal-main-title">${place.name||''}</div>
        ${stars}
        <div class="modal-detail">${addr}</div>
        ${place.formatted_phone_number?`<div class="modal-city"><b>Telefon:</b> ${place.formatted_phone_number}</div>`:""}
        <div class="modal-btn-group">${goBtn}${phoneBtn||''}${closeBtn}</div>
      </div>`;
  });
}
function closeModal(){ const bg=document.getElementById('modalBg'); bg.classList.remove('active'); setTimeout(()=>bg.innerHTML='', 250); }

/* Rota önizleme */
function startRoutePreview(name, lat, lng){
  closeModal();
  const dest = {lat, lng};
  updateRoute(dest, name);
  if(routeInterval) clearInterval(routeInterval);
  routeInterval = setInterval(()=>updateRoute(dest, name), 3000);
}
function updateRoute(dest, title){
  if(!userPos) return;
  directionsService.route({ origin:userPos, destination:dest, travelMode:google.maps.TravelMode.DRIVING }, (result, status)=>{
    if(status===google.maps.DirectionsStatus.OK){
      directionsRenderer.setDirections(result);
      const leg = result.routes[0].legs[0];
      showRouteInfoBox(title, leg.distance.text, leg.duration.text, dest.lat, dest.lng);
    }
  });
}
function showRouteInfoBox(title, distance, duration, lat, lng){
  const box=document.getElementById('routeInfoBox'), inner=document.getElementById('routeInfoInner');
  inner.innerHTML = `
    <div class="route-title">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="12" fill="${CATEGORY.color}"/></svg>
      ${title}
    </div>
    <div class="route-dist"><b>Mesafe:</b> ${distance}</div>
    <div class="route-dur"><b>Süre:</b> ${duration}</div>
    <div class="route-btn-group">
      <button class="route-gmaps-btn" onclick="goGoogleMaps(${lat},${lng})">Google Haritalar’da Yol Tarifi</button>
      <button class="route-cancel-btn" onclick="cancelRoute()">Kapat</button>
    </div>`;
  box.style.display="block";
}
function cancelRoute(){ directionsRenderer.set('directions', null); document.getElementById('routeInfoBox').style.display="none"; if(routeInterval) clearInterval(routeInterval); routeInterval=null; }
function goGoogleMaps(lat,lng){ window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`,'_blank'); }

/* init + popup */
window.initMap = initMap;
window.onload = showPopupAlways;
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-MpFcUMdFif1OPAGWcBhmWjWDPaM7Qz0&libraries=places&callback=initMap" async defer></script>
</body>
</html>
