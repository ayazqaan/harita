<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Viteska – Akaryakıt Haritası</title>
<style>
  *{
    -webkit-tap-highlight-color:transparent!important;
    outline:none!important;
    box-shadow:none!important;
    box-sizing:border-box;
  }
  :root{
    --accent:#e53935;
    --font:'Segoe UI',sans-serif;
    --radius:14px;
  }
  html,body{
    margin:0;padding:0;
    font-family:var(--font);
    width:100vw;height:100vh;
    background:#fff;
    overflow:hidden;
  }

  /* Üst bar */
.topbar{
  display:flex;
  justify-content:center;   /* ORTALAR */
  align-items:center;
  height:52px;
  background:#fff;
  border-bottom:2px solid #ececec;
  padding:0 10px;
}

  .top-pill{
    background:var(--accent);
    color:#fff;
    font-weight:800;
    font-size:1.03rem;
    padding:12px 18px;
    border-radius:4px;
  }

  /* Mesafe filtresi */
  .distance-bar{
    width:100%;
    background:#fff;
    display:flex;
    gap:10px;
    padding:8px 10px;
    border-bottom:2px solid #ececec;
  }
  .dist-btn{
    flex:1;
    padding:6px 0;
    background:#fff;
    border:2px solid #ffb6b6;
    border-radius:10px;
    font-weight:700;
    text-align:center;
    font-size:.86rem;
    color:#e53935;
    cursor:pointer;
    white-space:nowrap;
  }
  .dist-btn.active{
    background:#e53935;
    color:#fff;
    border-color:#e53935;
  }

  /* Harita alanı */
  #mapWrap{
    width:100vw;
    height:calc(100vh - 52px - 50px); /* topbar + mesafe filtresi */
    position:relative;
  }
  #map{width:100%;height:100%;}
  #mapLoading{
    position:absolute;
    top:50%;left:50%;
    transform:translate(-50%,-50%);
    background:#ffebea;
    color:#9d1f1d;
    font-weight:600;
    font-size:.95rem;
    padding:12px 16px;
    border-radius:12px;
    z-index:20;
    box-shadow:0 3px 12px #ffb6b240;
  }

  /* Rota kutusu */
  #routeInfoBox{
    position:fixed;
    left:0;bottom:0;
    width:100vw;
    z-index:30;
    display:none;
    pointer-events:none;
  }
  .route-info-inner{
    width:100vw;
    background:#fff;
    color:#222;
    border-radius:18px 18px 0 0;
    box-shadow:0 -4px 16px #0002;
    padding:16px 14px 12px;
    border-top:4px solid var(--accent);
    pointer-events:auto;
    font-size:.9rem;
  }
  .route-title{
    font-weight:800;
    font-size:1.02rem;
    color:var(--accent);
    margin-bottom:4px;
  }
  .route-line{margin:3px 0;font-weight:600;}
  .route-line span{color:#666;font-weight:500;}

  .route-btn-group{
    display:flex;
    gap:10px;
    margin-top:10px;
  }
  .route-gmaps-btn,.route-cancel-btn{
    flex:1;
    background:var(--accent);
    color:#fff;
    border:none;
    border-radius:10px;
    font-weight:700;
    font-size:.88rem;
    padding:8px;
    cursor:pointer;
  }
  .route-cancel-btn{background:#111;}
</style>
</head>
<body>

<!-- ÜST BAR -->
<div class="topbar">
  <div class="top-pill">Akaryakıt</div>
</div>

<!-- MESAFE FİLTRESİ -->
<div class="distance-bar">
  <div class="dist-btn active" data-radius="1000">1 KM</div>
  <div class="dist-btn" data-radius="500">500 M</div>
  <div class="dist-btn" data-radius="2000">2 KM</div>
  <div class="dist-btn" data-radius="5000">5 KM</div>
</div>

<!-- HARİTA -->
<div id="mapWrap">
  <div id="map"></div>
  <div id="mapLoading">Harita yükleniyor...</div>
</div>

<!-- ROTA PANEL -->
<div id="routeInfoBox">
  <div class="route-info-inner" id="routeInfoInner"></div>
</div>

<script>
/*** VİTESKA – AKARYAKIT HARİTASI (TOP 5 RENKLİ, DİĞERLERİ SİYAH) ***/

let map, userPos=null, userMarker=null;
let placesService, directionsService, directionsRenderer;
let markers = [];
let MAX_RESULTS = 25;
let SEARCH_RADIUS = 1000;      // varsayılan 1 km

/* En çok kullanılan 5 marka + diğer */
const BRAND_STYLES = {
  shell:   {label:"Shell",        color:"#ffc107"},
  po:      {label:"Petrol Ofisi", color:"#e53935"},
  opet:    {label:"Opet",         color:"#0277bd"},
  bp:      {label:"BP",           color:"#2e7d32"},
  total:   {label:"Total",        color:"#d32f2f"},
  other:   {label:"Diğer",        color:"#000000"}
};

/* İstasyon adından marka tahmin et */
function detectBrand(nameRaw){
  const name = (nameRaw || "").toLowerCase("tr");
  if(name.includes("shell")) return "shell";
  if(name.includes("petrol ofisi") || name.includes("p.o.") || name.includes(" po ")) return "po";
  if(name.includes("opet")) return "opet";
  if(name.includes("bp ")) return "bp";
  if(name.includes("total")) return "total";
  return "other";
}

/* Markaya göre marker ikonu */
function getBrandIcon(brandKey){
  const b = BRAND_STYLES[brandKey] || BRAND_STYLES.other;
  return {
    path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
    scale: 7,
    fillColor: b.color,
    fillOpacity: 1,
    strokeColor: "#ffffff",
    strokeWeight: 1
  };
}

/* Markerları sil */
function clearMarkers(){
  markers.forEach(m => m.setMap(null));
  markers = [];
}

/* Yakındaki istasyonları getir */
function loadStations(){
  if(!userPos || !placesService) return;

  clearMarkers();

  const request = {
    location: userPos,
    radius: SEARCH_RADIUS,
    type: "gas_station",
    language: "tr"
  };

  placesService.nearbySearch(request,(results,status)=>{
    if(status !== google.maps.places.PlacesServiceStatus.OK || !results){
      console.log("İstasyon bulunamadı:", status);
      return;
    }

    let count = 0;
    for(const place of results){
      if(count >= MAX_RESULTS) break;
      if(!place.geometry || !place.geometry.location) continue;

      const brandKey = detectBrand(place.name);

      const marker = new google.maps.Marker({
        map,
        position: place.geometry.location,
        title: place.name,
        icon: getBrandIcon(brandKey)
      });

      marker.addListener("click",()=> createRoute(place, brandKey));
      markers.push(marker);
      count++;
    }
  });
}

/* Haritayı başlat */
function initMap(){
  const loadingEl = document.getElementById("mapLoading");

  navigator.geolocation.getCurrentPosition(pos=>{
    userPos = {lat:pos.coords.latitude, lng:pos.coords.longitude};

    map = new google.maps.Map(document.getElementById("map"),{
      center:userPos,
      zoom:14,
      streetViewControl:false,
      mapTypeControl:false
    });

    userMarker = new google.maps.Marker({
      map,
      position:userPos,
      title:"Konumunuz",
      icon:{
        path: google.maps.SymbolPath.CIRCLE,
        scale: 8,
        fillColor:"#18b501",
        fillOpacity:1,
        strokeColor:"#ffffff",
        strokeWeight:2
      }
    });

    placesService      = new google.maps.places.PlacesService(map);
    directionsService  = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
      suppressMarkers:true,
      polylineOptions:{ strokeColor:"#e53935", strokeWeight:4 }
    });
    directionsRenderer.setMap(map);

    loadStations();
    loadingEl.style.display="none";

  },err=>{
    loadingEl.textContent = "Konum alınamadı!";
    console.error("Konum hatası:", err);
  }, {enableHighAccuracy:true, timeout:8000});
}

/* Rota oluştur */
function createRoute(place, brandKey){
  directionsService.route({
    origin: userPos,
    destination: place.geometry.location,
    travelMode: "DRIVING"
  },(res,status)=>{
    if(status !== google.maps.DirectionsStatus.OK || !res) return;

    directionsRenderer.setDirections(res);
    const leg = res.routes[0].legs[0];
    const brand = BRAND_STYLES[brandKey] || BRAND_STYLES.other;

    showRouteInfo({
      title: place.name,
      brand: brand.label,
      address: place.vicinity || "",
      distance: leg.distance.text,
      duration: leg.duration.text,
      lat: place.geometry.location.lat(),
      lng: place.geometry.location.lng()
    });
  });
}

/* Alt rota panelini doldur */
function showRouteInfo(data){
  const box   = document.getElementById("routeInfoBox");
  const inner = document.getElementById("routeInfoInner");

  inner.innerHTML = `
    <div class="route-title">${data.title}</div>
    <div class="route-line"><b>Marka:</b> <span>${data.brand}</span></div>
    ${data.address ? `<div class="route-line"><b>Adres:</b> <span>${data.address}</span></div>` : ""}
    <div class="route-line"><b>Mesafe:</b> <span>${data.distance}</span></div>
    <div class="route-line"><b>Süre:</b> <span>${data.duration}</span></div>

    <div class="route-btn-group">
      <button class="route-gmaps-btn" onclick="goMaps(${data.lat},${data.lng})">Google Haritalar</button>
      <button class="route-cancel-btn" onclick="closeRoute()">Kapat</button>
    </div>
  `;

  box.style.display = "block";
}

function goMaps(lat,lng){
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`,"_blank");
}

function closeRoute(){
  document.getElementById("routeInfoBox").style.display="none";
  if(directionsRenderer) directionsRenderer.set("directions", null);
}

/* MESAFE FİLTRESİ */
document.addEventListener("click", e=>{
  if(e.target.classList.contains("dist-btn")){
    document.querySelectorAll(".dist-btn").forEach(btn=>btn.classList.remove("active"));
    e.target.classList.add("active");

    SEARCH_RADIUS = Number(e.target.dataset.radius);
    loadStations();
  }
});

window.initMap = initMap;
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-MpFcUMdFif1OPAGWcBhmWjWDPaM7Qz0&libraries=places&callback=initMap" async defer></script>
</body>
</html>
