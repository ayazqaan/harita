<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Viteska ‚Äì Trafik Durumu</title>

<style>
  :root{
    --brand:#f27405;
    --bg:#fff;
    --radius:14px;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
  body,html{margin:0;padding:0;height:100%;overflow:hidden;font-family:'Segoe UI',sans-serif;background:#fff;}

  /* ARAMA KUTUSU */
  .search-box{
    position:fixed;top:0;z-index:999;width:100%;
    background:#fff;padding:10px;border-bottom:2px solid #ffe2c2;
  }
  #searchInput{
    width:100%;padding:12px 14px;font-size:1rem;
    border:2px solid #ffd2a8;border-radius:var(--radius);
    font-weight:600;
  }
  #searchInput:focus{border-color:var(--brand);box-shadow:0 0 7px #f2740535;}

  /* TRAFƒ∞K RENK Lƒ∞STESƒ∞ */
  .legend-bar{
    position:fixed;top:64px;left:50%;transform:translateX(-50%);
    display:flex;gap:10px;background:#fff;padding:8px 12px;
    border-radius:0 0 var(--radius) var(--radius);
    border-bottom:2px solid #ffe2c2;
    box-shadow:0 3px 10px #f2740530;
    z-index:50;
  }
  .legend-item{display:flex;align-items:center;gap:6px;font-size:.9rem;font-weight:700}
  .legend-color{width:18px;height:10px;border-radius:4px;}

  /* HARƒ∞TA */
  #map{width:100vw;height:100vh;}

  /* ALT BAR ‚Äì TRAFƒ∞K + YOƒûUNLUK KUTUSU */
  .bottom-bar{
    position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
    display:flex;gap:10px;z-index:99;
  }
  .traffic-toggle{
    padding:10px 18px;font-weight:800;border-radius:var(--radius);
    background:#fff;border:2px solid #ffd2a8;color:var(--brand);
    box-shadow:0 4px 14px #f2740530;cursor:pointer;
    white-space:nowrap;
  }
  .traffic-info{
    padding:9px 14px;font-size:.85rem;font-weight:700;
    border-radius:var(--radius);
    background:#fff;border:2px solid #ffd2a8;color:#444;
    box-shadow:0 4px 14px #f2740530;min-width:150px;
  }

  /* ROTA PANELƒ∞ */
  .route-panel{
    position:fixed;left:50%;bottom:0;transform:translate(-50%,110%);
    width:100%;max-width:480px;background:#fff;padding:18px 16px;
    border-radius:var(--radius) var(--radius) 0 0;
    box-shadow:0 -5px 22px #0003;z-index:999;
    transition:all .25s ease;
  }
  .route-panel.show{transform:translate(-50%,0);}
  .r-title{font-size:1.1rem;font-weight:800;color:var(--brand);}
  .r-line{font-weight:600;margin:6px 0;}
  .r-btns{display:flex;gap:12px;margin-top:12px;}
  .r-btn{flex:1;padding:10px;font-weight:700;border-radius:10px;color:#fff;background:var(--brand);border:none;}
  .r-btn.close{background:#222;}

  /* Ara√ß / Yaya modu */
  .mode-toggle{
    display:flex;gap:8px;margin-bottom:8px;
  }
  .mode-btn{
    flex:1;
    padding:6px 0;
    font-size:.85rem;
    font-weight:700;
    border-radius:999px;
    border:2px solid #ffd2a8;
    background:#fff;
    color:#555;
    cursor:pointer;
  }
  .mode-btn.active{
    background:var(--brand);
    color:#fff;
    border-color:var(--brand);
  }
</style>
</head>
<body>

<!-- ARAMA -->
<div class="search-box">
  <input id="searchInput" type="text" placeholder="Konum veya adres ara...">
</div>

<!-- LEGEND -->
<div class="legend-bar">
  <div class="legend-item"><div class="legend-color" style="background:#00c853;"></div>Akƒ±cƒ±</div>
  <div class="legend-item"><div class="legend-color" style="background:#ffeb3b;"></div>Yoƒüun</div>
  <div class="legend-item"><div class="legend-color" style="background:#ff5722;"></div>Sƒ±kƒ±≈üƒ±k</div>
  <div class="legend-item"><div class="legend-color" style="background:#9e9e9e;"></div>Kapalƒ±</div>
</div>

<!-- HARƒ∞TA -->
<div id="map"></div>

<!-- ALT BAR: TRAFƒ∞K + YOƒûUNLUK -->
<div class="bottom-bar">
  <button id="toggleBtn" class="traffic-toggle">Trafik: A√áIK</button>
  <div id="trafficInfo" class="traffic-info">3 km √ßevre: -</div>
</div>

<!-- ROTA PANELƒ∞ -->
<div class="route-panel" id="routePanel">
  <div class="mode-toggle">
    <button class="mode-btn active" data-mode="DRIVING">Ara√ß</button>
    <button class="mode-btn" data-mode="WALKING">Yaya</button>
  </div>

  <div class="r-title" id="rTitle">Rota</div>
  <div class="r-line" id="rDist"></div>
  <div class="r-line" id="rTimeTraffic"></div>
  <div class="r-line" id="rTimeNoTraffic"></div>
  <div class="r-line" id="rImpact"></div>
  <div class="r-btns">
    <button class="r-btn" id="openMapsBtn">Google Maps</button>
    <button class="r-btn close" onclick="closeRoute()">Kapat</button>
  </div>
</div>

<script>
let map, trafficLayer;
let userPos = null, userMarker = null;
let directionsService, directionsRenderer;
let autocomplete;
let currentMode = "DRIVING"; // "DRIVING" veya "WALKING"
let areaTrafficTimer = null;
let lastRouteDest = null; // {lat,lng,title}

/* --- HARƒ∞TA BA≈ûLANGICI --- */
function initMap(){
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({
    suppressMarkers:true,
    polylineOptions:{ strokeColor:"#f27405", strokeWeight:5 }
  });

  map = new google.maps.Map(document.getElementById('map'), {
    center:{lat:39.92,lng:32.85}, // fallback Ankara
    zoom:12,
    streetViewControl:false,
    mapTypeControl:false
  });
  directionsRenderer.setMap(map);

  trafficLayer = new google.maps.TrafficLayer();
  trafficLayer.setMap(map);

  /* ƒ∞LK A√áILI≈ûTA KONUMU AL VE HARƒ∞TAYI ORAYA KUR */
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      userPos = {
        lat:pos.coords.latitude,
        lng:pos.coords.longitude
      };

      map.setCenter(userPos);
      map.setZoom(14);

      userMarker = new google.maps.Marker({
        map,
        position:userPos,
        icon:{
          path:google.maps.SymbolPath.CIRCLE,
          scale:8,
          fillColor:"#18b501",
          fillOpacity:1,
          strokeColor:"#fff",
          strokeWeight:2
        }
      });

      // CANLI TAKƒ∞P ‚Äì sadece marker g√ºncelleniyor
      navigator.geolocation.watchPosition(wPos=>{
        userPos = {
          lat:wPos.coords.latitude,
          lng:wPos.coords.longitude
        };
        if(userMarker){
          userMarker.setPosition(userPos);
        }
      });

      // Konum geldikten sonra 3 km √ßevre trafik yoƒüunluƒüunu hesapla
      computeAreaTraffic();
      areaTrafficTimer = setInterval(computeAreaTraffic, 120000); // 2 dakikada bir g√ºncelle
    },err=>{
      console.error("Konum alƒ±namadƒ±:", err);
    }, {enableHighAccuracy:true, timeout:10000});
  }

  /* HARƒ∞TAYA TIKLAYINCA ROTA */
  map.addListener("click",(e)=>{ 
    createRoute(e.latLng.lat(),e.latLng.lng(),"Se√ßilen Nokta"); 
  });

  /* TRAFƒ∞K A√á/KAPA */
  document.getElementById("toggleBtn").onclick=()=>{
    const active = trafficLayer.getMap();
    trafficLayer.setMap(active?null:map);
    document.getElementById("toggleBtn").textContent = active ? "Trafik: KAPALI" : "Trafik: A√áIK";
  };

  initSearch();
  initModeToggle();
}

/* --- MOD SE√áƒ∞Mƒ∞ (ARA√á / YAYA) --- */
function initModeToggle(){
  document.addEventListener("click",e=>{
    if(!e.target.classList.contains("mode-btn")) return;
    const mode = e.target.dataset.mode;
    if(!mode) return;

    currentMode = mode; // DRIVING / WALKING

    document.querySelectorAll(".mode-btn").forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.mode === mode);
    });

    // Eƒüer daha √∂nce rota olu≈üturulduysa aynƒ± hedefe g√∂re yeni moda g√∂re yeniden hesapla
    if(lastRouteDest){
      createRoute(lastRouteDest.lat, lastRouteDest.lng, lastRouteDest.title, true);
    }
  });
}

/* --- ARAMA --- */
function initSearch(){
  const input = document.getElementById("searchInput");
  autocomplete = new google.maps.places.Autocomplete(input,{
    types:["geocode","establishment"],
    componentRestrictions:{country:"tr"},
    fields:["name","geometry","formatted_address"]
  });

  autocomplete.addListener("place_changed",()=>{
    const place = autocomplete.getPlace();
    if(!place.geometry) return;

    map.panTo(place.geometry.location);
    map.setZoom(15);

    createRoute(
      place.geometry.location.lat(),
      place.geometry.location.lng(),
      place.name || place.formatted_address
    );
  });
}

/* --- 3 KM √áEVRE TRAFƒ∞K YOƒûUNLUƒûU --- */
function computeAreaTraffic(){
  if(!userPos || !directionsService) return;

  // Yakla≈üƒ±k 3 km kuzeye bir nokta (1 derece enlem ‚âà 111 km)
  const dLat = 3 / 111; 
  const dest = {lat: userPos.lat + dLat, lng: userPos.lng};

  const req = {
    origin: userPos,
    destination: dest,
    travelMode: "DRIVING",
    drivingOptions:{
      departureTime:new Date(),
      trafficModel:"bestguess"
    }
  };

  directionsService.route(req,(res,status)=>{
    if(status !== "OK" || !res || !res.routes.length) return;
    const leg = res.routes[0].legs[0];
    if(!leg.duration_in_traffic){
      updateTrafficInfo(null);
      return;
    }
    const secTraffic   = leg.duration_in_traffic.value;
    const secNoTraffic = leg.duration.value;
    let impact = Math.round(((secTraffic - secNoTraffic) / secNoTraffic) * 100);
    if(impact < 0) impact = 0;
    updateTrafficInfo(impact);
  });
}

/* --- YOƒûUNLUK KUTUSU (3 KM √áEVRE) --- */
function updateTrafficInfo(impact){
  const el = document.getElementById("trafficInfo");
  if(impact === null || isNaN(impact)){
    el.textContent = "3 km √ßevre: -";
    return;
  }
  let durum;
  if(impact <= 5)      durum = "Akƒ±cƒ±";
  else if(impact <=20) durum = "Hafif";
  else if(impact <=40) durum = "Yoƒüun";
  else                 durum = "√áok Yoƒüun";

  el.textContent = `3 km √ßevre: ${durum} (%${impact})`;
}

/* --- ROTA OLU≈ûTURMA --- */
function createRoute(lat,lng,title, fromModeChange=false){
  if(!userPos) return alert("Konum alƒ±namadƒ±!");

  // Son hedefi hatƒ±rla (mod deƒüi≈ütirmede tekrar kullanacaƒüƒ±z)
  lastRouteDest = {lat, lng, title};

  const req = {
    origin:userPos,
    destination:{lat,lng},
    travelMode: currentMode
  };

  if(currentMode === "DRIVING"){
    req.drivingOptions = {
      departureTime:new Date(),
      trafficModel:"bestguess"
    };
  }

  directionsService.route(req,(res,status)=>{
    if(status==="OK"){
      directionsRenderer.setDirections(res);
      const leg = res.routes[0].legs[0];

      const rDist  = document.getElementById("rDist");
      const rTimeT = document.getElementById("rTimeTraffic");
      const rTimeN = document.getElementById("rTimeNoTraffic");
      const rImp   = document.getElementById("rImpact");

      document.getElementById("rTitle").textContent="üìç "+title;
      rDist.textContent = "Mesafe: "+leg.distance.text;

      if(currentMode === "DRIVING"){
        const withTrafficText = leg.duration_in_traffic ? leg.duration_in_traffic.text : leg.duration.text;
        const noTrafficText   = leg.duration.text;

        const secTraffic   = leg.duration_in_traffic ? leg.duration_in_traffic.value : leg.duration.value;
        const secNoTraffic = leg.duration.value;
        let impact = Math.round(((secTraffic - secNoTraffic) / secNoTraffic) * 100);
        if(impact < 0) impact = 0;

        rTimeT.textContent = "Trafikli: " + withTrafficText;
        rTimeN.textContent = "Trafiksiz: " + noTrafficText;
        rImp.textContent   = "Bu rotadaki trafik etkisi: %" + impact;
      }else{
        // YAYA MODU: sadece y√ºr√ºy√º≈ü s√ºresi g√∂ster, trafik bilgisi yok
        rTimeT.textContent = "Y√ºr√ºy√º≈ü s√ºresi: " + leg.duration.text;
        rTimeN.textContent = "";
        rImp.textContent   = "";
      }

      document.getElementById("openMapsBtn").onclick=()=>{
        const modeParam = currentMode === "DRIVING" ? "driving" : "walking";
        window.open(
          `https://www.google.com/maps/dir/?api=1&origin=${userPos.lat},${userPos.lng}&destination=${lat},${lng}&travelmode=${modeParam}`
        );
      };

      document.getElementById("routePanel").classList.add("show");
    }
  });
}

function closeRoute(){
  document.getElementById("routePanel").classList.remove("show");
  directionsRenderer.set("directions",null);
}
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-MpFcUMdFif1OPAGWcBhmWjWDPaM7Qz0&libraries=places&callback=initMap" async defer></script>
</body>
</html>
