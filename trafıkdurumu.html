<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Viteska â€“ Trafik Durumu</title>

<style>
  :root{
    --brand:#f27405;
    --bg:#fff;
    --radius:14px;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
  body,html{margin:0;padding:0;height:100%;overflow:hidden;font-family:'Segoe UI',sans-serif;background:#fff;}

  /* ARAMA KUTUSU */
  .search-box{
    position:fixed;top:0;z-index:999;width:100%;
    background:#fff;padding:10px;border-bottom:2px solid #ffe2c2;
  }
  #searchInput{
    width:100%;padding:12px 14px;font-size:1rem;
    border:2px solid #ffd2a8;border-radius:var(--radius);
    font-weight:600;
  }
  #searchInput:focus{border-color:var(--brand);box-shadow:0 0 7px #f2740535;}

  /* TRAFÄ°K RENK LÄ°STESÄ° */
  .legend-bar{
    position:fixed;top:64px;left:50%;transform:translateX(-50%);
    display:flex;gap:10px;background:#fff;padding:8px 12px;
    border-radius:0 0 var(--radius) var(--radius);
    border-bottom:2px solid #ffe2c2;
    box-shadow:0 3px 10px #f2740530;
    z-index:50;
  }
  .legend-item{display:flex;align-items:center;gap:6px;font-size:.9rem;font-weight:700}
  .legend-color{width:18px;height:10px;border-radius:4px;}

  /* HARÄ°TA */
  #map{width:100vw;height:100vh;}

  /* TRAFÄ°K AÃ‡/KAPA */
  .traffic-toggle{
    position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
    padding:10px 18px;font-weight:800;border-radius:var(--radius);
    background:#fff;border:2px solid #ffd2a8;color:var(--brand);
    box-shadow:0 4px 14px #f2740530;z-index:99;cursor:pointer;
  }

  /* ROTA PANELÄ° */
  .route-panel{
    position:fixed;left:50%;bottom:0;transform:translate(-50%,110%);
    width:100%;max-width:480px;background:#fff;padding:18px 16px;
    border-radius:var(--radius) var(--radius) 0 0;
    box-shadow:0 -5px 22px #0003;z-index:999;
    transition:all .25s ease;
  }
  .route-panel.show{transform:translate(-50%,0);}
  .r-title{font-size:1.1rem;font-weight:800;color:var(--brand);}
  .r-line{font-weight:600;margin:6px 0;}
  .r-btns{display:flex;gap:12px;margin-top:12px;}
  .r-btn{flex:1;padding:10px;font-weight:700;border-radius:10px;color:#fff;background:var(--brand);border:none;}
  .r-btn.close{background:#222;}

</style>
</head>
<body>

<!-- ARAMA -->
<div class="search-box">
  <input id="searchInput" type="text" placeholder="Konum veya adres ara...">
</div>

<!-- LEGEND -->
<div class="legend-bar">
  <div class="legend-item"><div class="legend-color" style="background:#00c853;"></div>AkÄ±cÄ±</div>
  <div class="legend-item"><div class="legend-color" style="background:#ffeb3b;"></div>YoÄŸun</div>
  <div class="legend-item"><div class="legend-color" style="background:#ff5722;"></div>SÄ±kÄ±ÅŸÄ±k</div>
  <div class="legend-item"><div class="legend-color" style="background:#9e9e9e;"></div>KapalÄ±</div>
</div>

<!-- HARÄ°TA -->
<div id="map"></div>

<!-- TRAFÄ°K AÃ‡/KAPA -->
<button id="toggleBtn" class="traffic-toggle">Trafik: AÃ‡IK</button>

<!-- ROTA PANELÄ° -->
<div class="route-panel" id="routePanel">
  <div class="r-title" id="rTitle">Rota</div>
  <div class="r-line" id="rDist"></div>
  <div class="r-line" id="rTimeTraffic"></div>
  <div class="r-line" id="rTimeNoTraffic"></div>
  <div class="r-line" id="rImpact"></div>
  <div class="r-btns">
    <button class="r-btn" id="openMapsBtn">Google Maps</button>
    <button class="r-btn close" onclick="closeRoute()">Kapat</button>
  </div>
</div>

<script>
let map, trafficLayer;
let userPos=null, userMarker=null;
let directionsService, directionsRenderer;
let autocomplete;

/* --- HARÄ°TA BAÅžLANGICI --- */
function initMap(){
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({
    suppressMarkers:true,
    polylineOptions:{ strokeColor:"#f27405", strokeWeight:5 }
  });

  map = new google.maps.Map(document.getElementById('map'), {
    center:{lat:39.92,lng:32.85}, zoom:12,
    streetViewControl:false, mapTypeControl:false
  });
  directionsRenderer.setMap(map);

  trafficLayer = new google.maps.TrafficLayer();
  trafficLayer.setMap(map);

  /* KONUM TAKÄ°BÄ° */
  if(navigator.geolocation){
    navigator.geolocation.watchPosition(pos=>{
      userPos = {
        lat:pos.coords.latitude,
        lng:pos.coords.longitude
      };
      if(!userMarker){
        map.setCenter(userPos);
        map.setZoom(14);
        userMarker = new google.maps.Marker({
          map, position:userPos,
          icon:{
            path:google.maps.SymbolPath.CIRCLE,
            scale:8, fillColor:"#18b501",
            fillOpacity:1, strokeColor:"#fff", strokeWeight:2
          }
        });
      } else userMarker.setPosition(userPos);
    });
  }

  /* HARÄ°TAYA TIKLAYINCA ROTA */
  map.addListener("click",(e)=>{ 
    createRoute(e.latLng.lat(),e.latLng.lng(),"SeÃ§ilen Nokta"); 
  });

  /* TRAFÄ°K AÃ‡/KAPA */
  document.getElementById("toggleBtn").onclick=()=>{
    const active = trafficLayer.getMap();
    trafficLayer.setMap(active?null:map);
    document.getElementById("toggleBtn").textContent = active ? "Trafik: KAPALI" : "Trafik: AÃ‡IK";
  };

  initSearch();
}

/* --- ARAMA --- */
function initSearch(){
  const input = document.getElementById("searchInput");
  autocomplete = new google.maps.places.Autocomplete(input,{
    types:["geocode","establishment"],
    componentRestrictions:{country:"tr"},
    fields:["name","geometry","formatted_address"]
  });

  autocomplete.addListener("place_changed",()=>{
    const place = autocomplete.getPlace();
    if(!place.geometry) return;

    map.panTo(place.geometry.location);
    map.setZoom(15);

    createRoute(
      place.geometry.location.lat(),
      place.geometry.location.lng(),
      place.name || place.formatted_address
    );
  });
}

/* --- ROTA OLUÅžTURMA --- */
function createRoute(lat,lng,title){
  if(!userPos) return alert("Konum alÄ±namadÄ±!");

  directionsService.route({
    origin:userPos,
    destination:{lat,lng},
    travelMode:"DRIVING",
    drivingOptions:{
      departureTime:new Date(),
      trafficModel:"bestguess"
    }
  },(res,status)=>{
    if(status==="OK"){
      directionsRenderer.setDirections(res);
      const leg = res.routes[0].legs[0];

      const withTraffic = leg.duration_in_traffic ? leg.duration_in_traffic.text : leg.duration.text;
      const noTraffic = leg.duration.text;

      const secTraffic = leg.duration_in_traffic ? leg.duration_in_traffic.value : leg.duration.value;
      const secNoTraffic = leg.duration.value;

      const impact = Math.round(((secTraffic - secNoTraffic) / secNoTraffic) * 100);

      document.getElementById("rTitle").textContent="ðŸ“ "+title;
      document.getElementById("rDist").textContent="Mesafe: "+leg.distance.text;
      document.getElementById("rTimeTraffic").textContent="Trafikli: "+withTraffic;
      document.getElementById("rTimeNoTraffic").textContent="Trafiksiz: "+noTraffic;

      document.getElementById("rImpact").textContent=
        "YoÄŸunluk Etkisi: %" + (impact > 0 ? impact : 0);

      document.getElementById("openMapsBtn").onclick=()=>{
        window.open(`https://www.google.com/maps/dir/?api=1&origin=${userPos.lat},${userPos.lng}&destination=${lat},${lng}`);
      };

      document.getElementById("routePanel").classList.add("show");
    }
  });
}

function closeRoute(){
  document.getElementById("routePanel").classList.remove("show");
  directionsRenderer.set("directions",null);
}
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-MpFcUMdFif1OPAGWcBhmWjWDPaM7Qz0&libraries=places&callback=initMap" async defer></script>
</body>
</html>
